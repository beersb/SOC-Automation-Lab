# SOC-Automation-Lab

## Objective

The SOC Automation Lab project aimed to establish a controlled environment for simulating and detecting cyber attacks and experiment with Security Orchestration, Automation, and Response (SOAR) technology by generating automated alert response actions using Shuffle Automation. The primary focus was to ingest and analyze logs within a Security Information and Event Management (SIEM) system, generating test telemetry to mimic real-world attack scenarios, and then feeding this data into the Shuffle framework in order to produce an automated response (in this case, sending an email). This hands-on experience was designed to deepen understanding of both SIEM and SOAR technologies, attack patterns, and defensive strategies. I would like to especially thank and acknowledge the MyDFIR YouTube channel (Insert Hyperlink) for providing a detailed tutorial on setting up and configuring this project. 

### Skills Learned

- Advanced understanding of SIEM concepts and their practical application.
- Increased understanding of SOAR conecpts and their practical application.
- Ability to generate and recognize attack signatures and patterns.
- Enhanced knowledge of network protocols and security vulnerabilities.
- Development of critical thinking and problem-solving skills in cybersecurity.

### Tools Used

- Security Information and Event Management (SIEM) system for log ingestion and analysis (Wazuh).
- Security Orchestration, Automation, and Response (SOAR) system for automated response to security alerts generated by the SIEM (Shuffle Automation).
- Telemetry generation tools to create realistic network traffic and attack scenarios.

## Steps

As breifly explained above, the overall goal of this project was to set-up a basic SOC environment using Wazuh, configure this environment to detect Mimikatz activity via an alert, and then use Shuffle Automation to send an email to a hypothetical SOC analyst in response to this alert. Once this point has been reach, the project will be expanded using Shuffle to provide SOAR functionality. To implement this, several machines were utilized:  the SOC analyst machine (my laptop), a Windows 10 host, and a Ubuntu 22.04 LTS servers (to host Wazuh). Both the Windows and Ubuntu machines will be hosted in the cloud using Vultr as the provider. A network diagram illustrating this setup is provided immediately below.

<div>
  <img src="./SOC%20Automation%20Lab%20Network%20XML.drawio.png" alt="SOC Automation Network Diagram" width="700" height="700">
</div>

*Ref 1: Network Diagram*

### Deploying the Windows 10 Client and Installing Sysmon
The first step in the lab will be to deploy the Windows 10 client which will act as the victim in our project scenario. To do this, we navigate to our Vultr panel and deploy a new instance, specifying Windows 10 as the operating system and allocating an appropriate amount of RAM, storage, and CPU cores. We also create a Firewall policy that blocks all traffic from all IP addresses except for the SOC analyst laptop, which is given TCP access on all ports, and then add the new Windows host to this policy. This is a critical step, as otherwise our host will be exposed to the entire internet, and will be the victim of a shockingly large number of automated brute force attacks (see the 30 Day Challenge project for an account of my first encounter with this phenomenon). 

Once we have the host up and running, we will use the Windows Remote Desktop Protocol (RDP) to connect to it via our SOC Analyst laptop in order to install Sysmon. Sysmon is a Windows service used to collect detailed information on process creation, network connections, and even file modification. 

<div>
  <img src="lab_images/Firewall Group.png" alt="SOC Automation Network Diagram" width="1100" height="150">
  
  *Ref. 2: A screenshot of the single rule added to the Auto-SOC-Default Firewall Group, the IP address of the SOC Analyst laptop has been redacted for the privacy of the author*
</div>

We will be using Sysmon to detect the actions of a simulated hack further on in the lab, and it will accordingly be Sysmon data that will be ingested by our SIEM.

To install the applicaiton, we navigate to the official download page on Microsoft's website:

    https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon

and follow the usual procedure for downloading something from the internet. Once the download is finished, a folder called Sysmon.zip will be present in the downloads folder. This folder must be extracted, it doesn't really matter where, but in this case we will just use the Downloads folder. Next, we will need to grab the configuration file we will be using from the Github page at which it is hosted:

    https://github.com/olafhartong/sysmon-modular/blob/master/sysmonconfig.xml

saving the file in the extracted Sysmon folder we just created. 

<div>
  <img src="lab_images/Sysmonconfig.png" alt="SOC Automation Network Diagram" width="1100" height="200">
  
  *Ref. 3: The beginning of the Sysmon configuration file utilized in this project*
</div>

Once this is accomplished, we need to open a PowerShell session as an administrator and run the installation executable. To do so, we navigate to the appropriate directory,

    cd C:\Users\Administrator\Downloads\Sysmon

and then run the executable, using the -i option to specify the configuration file:

    .\Sysmon64 -i sysmonconfig.xml

Now, we check the Windows services list to ensure that Sysmon has indeed been installed and is present on the machine. To do this, one navigates to the Services app (which can be found by simply searching for 'services' in the Windows start menu), then scrolling to the S section of the window (the services are ordered alphabetically) and searching for Sysmon64 on the list. In this case, we are successful and will move onto the next step, creating the Wazuh server.

<div>
  <img src="lab_images/Sysmon install success.png" alt="SOC Automation Network Diagram" width="1100" height="600">
  
  *Ref. 3: A snapshot demonstrating the location of the Sysmon64 service in the Windows services list*
</div>

### Deploying the Wazuh Server
Now, we move onto the Wazuh server. Q? What is Wazuh?
In this case, our Wazuh server will be located in the cloud, hosted by Vultr, instead of a VM on our local machine. So, to get started we first login to our Vultr account through their web portal. We then deploy a new server, named Auto-SOC-Wazuh, using Ubuntu 22.04 LTS for the operating system. In terms of system resources, this system will be somewhat beefy, although it is by no means a monster, weighing in at 8GB of RAM and ***GB of storage. Once the server is ready to go, we'll create a new Firewall Group on Vultr, allowing all TCP traffic but only for my local IP. Thus, we will be saved from constant attempts to break into the server by bots. We will add not only the Wazuh server to this group, but TheHive host as well.

<div>
  <img src="lab_images/Firewall Group.png" alt="SOC Automation Network Diagram" width="1100" height="150">
  
  *Ref. 4: A screenshot of the single rule added to the Auto-SOC-Default Firewall Group*
</div>

As soon as the serve finishes booting up, we ssh into its root account via a PowerShell session on the SOC Analyst Laptop, inputting credentials as necessary. In this case, we will install Wazuh using an automated script, which can be found in the Wazuh documentation and may be executed with the following:
  
    curl -sO https://packages.wazuh.com/4.9/wazuh-install.sh && bash wazuh-install.sh -a

It would no doubt be beneficial to practice installing the application by hand. This however, must await a future date when the lab will be redone using only manual installation techniques. as the script ran, it was provided a message that ports 1514, 1515, and 443 must all be open. Accordingly, we allowed these ports through the firewall on our machine via ufw:

    ufw allow 1515
    ufw allow 1514
    ufw allow 443
    
after the script was finished running. The script was able to finish running successfully, and we are presented with a message displaying the default credentials to be used to login into the web console:

<div>
  <img src="lab_images/Wazuh Finished + Password.png" alt="SOC Automation Network Diagram" width="900" height="75">

  *Ref. 5: A screenshot of the Wazuh credentials and installation completion message. The server has been dismantled so these credentials no longer correspond to a live instance*
</div>

### Configuring Wazuh
In this step, we will be installing an agent on our Windows machine. This agent will be responsible for ingesting the sysmon data generated on that machine, and sending it to the Wazuh server for processing. To begin, we need to access the Wazuh application via web browser, and so we navigate to the public IP address of the Wazuh server:

    https://66.42.82.228
    
(Wazuh defaults to port 443 so we don't need to specify the port in our address). We are thus presented with the Wazuh login screen, and after inputting the credentials outputted in the installation process, we gain access to the Wazuh console.  

<div>
  <img src="lab_images/Wazuh_Console_Success.png" alt="SOC Automation Network Diagram" width="700" height="300">

  *Ref. 12: A screenshot of the Wazuh console page upon initial login*
</div>

There will be a convenient link to add a new agent prominently displayed on the console, and we can simply click this link to begin the process of installing the Wazuh agent on our Windows machine. 

Once the link has been clicked, we must specify the operating system of the host on which the agent will be installed, the address the agent will use to communicate with the central Wazuh server (the public IP address of our Wazuh server in this case), as well as optional settings such as an agent name and a group. We will skip the group for now, but input the agent name as Auto-SOC-WIN. After filling in the necessary information, a PowerShell command will be provided that can be used to download the agent on our Windows machine. Thus, we RDP into the machine and run the command. 

<div>
  <img src="lab_images/Downloading_Wazuh_Agent.png" alt="SOC Automation Network Diagram" width="700" height="100">

  *Ref. 13: The PowerShell command which downloads the Wazuh agent onto the Windows host*
</div>

After the command finishes exuting, we start the Wazuh service on our Windows host with the command below:

    net start wazuhsvc

and then hope the agent is able to orchestrate a connection with the Wazuh server. We can verify the object of our hope by checking back into the Wazuh console to see if the agent has connected to Wazuh successfully, and in our case, the connection was indeed successful. 

<div>
  <img src="lab_images/Windows_Agent_Connected.png" alt="SOC Automation Network Diagram" width="650" height="250">

  *Ref. 14: The Wazuh console after our Windows agent has successfully connected*
</div>

Now that we have a working Wazuh agent, we create a Wazuh rule for detecting the malicious executable Mimikatz. 

### Downloading Mimikatz and Creating a Rule to Detect It
As alluded to in the conluding lines of the last session, it is now finally time to simulate some malicious activity on our Windows host and we will hopefully be able to detect this technological malfeasance on through our Wazuh SIEM. First, we'll load up Mimikatz on the Windows target, and once this is done, we'll proceed to create the rule to detect it. 

To download Mimikatz, we will first need to add an exclusion to our Windows Defender configuration. An exlusion instructs Defender to not scan a particular folder, file, file type, or process, and we will need to add such an exlusion to the folder into which we intend to download Mimikatz, otherwise Defender will remove it from our machine immediately upon install (this is usually a good thing, as Mimikatz is a very well known malicious file used to pillage the Windows LSASS system for user credentials!). To add the exclusion, one must again open the Start Menu, and search for Windows Security or just Security and select the Windows Security result. From here, we will select the 'Virus & threat protection' option, and then the 'Manage settings' link under 'Virus & threat protection settings'. Then, we scroll all the way to the bottom of the page and click 'Add or remove an exclusion' under Exlusions, then 'Yes' to allow Windows Security to make changes to the device. Finally, we select the 'Add an exclusion+' button, select Folder from the drop-down menu, and then input the file-path for Mimikatz. In my case, I used the Downloads folder, which would be highly unwise if this were a production environment. 

<div>
  <img src="lab_images/part_4/Excluding the Downloads Folder.png" alt="SOC Automation Network Diagram" width="750" height="350">

  *Ref. 17: An image showing how an exclusion is displayed in the exlusions menu after it has been successfully added*
</div>

Now that Windows Defender will not look askance at our file, we may download it.  <INSERT DOWNLOAD PROCESS FOR MIMIKATZ HERE>

Now, we move on to the Wazuh agent. First, we need to configure the Wazuh agent on our Windows host to ingest the logs generated by Sysmon, as this functionality is not present in the default configuration. The configuration file for the agent is located at the following path:

    C:\Program Files (x86)\ossec-agent\ossec.conf

It's best to copy this file as a backup just in case we make a mistake and our agent breaks. On Windows machines, this is especially straighforward, and can be accomplished by simply right-clicking on the file, selecting copy, and then pasting the copied file in the same location as the original. In our case, we renamed the file to reflect that it was a backup. Now, we open the file configuration file using Notepad. According to the Wazuh documentation (contained in the references section of this project, located below), we will need to add the following lines of code in order for our agent to being collecting logs from Sysmon:

<div>
  <img src="lab_images/part_4/Configure Wazuh Agent to get Sysmon.png" alt="SOC Automation Network Diagram" width="750" height="125">

  *Ref. 16: A snapshot of the lines added to the Wazuh agent configuration file to enable Sysmon ingestion*
</div>

Once we have added these lines to the file, we need to save the file and restart the Sysmon service so it can read in the changes we just made to its configuration. We can do this in a few different ways, the most straightforward of which is to simply execute the below command in a PowerShell session.

    Restart-Service -Name wazuh

If, however, GUIs are more your style, this can also be done via the Services applicaiton on the Windows machine. One simply needs to search for 'services' in the Start Menu, select the first option, and then find the Wazuh service within the services list and select it. There should then be a restart option to select in the righthand side of the window. 

<div>
  <img src="lab_images/part_4/Restarting Wazuh.png" alt="SOC Automation Network Diagram" width="750" height="250">

  *Ref. 17: An image portraying the Wazuh service from within the Windows Services application which portrays the Restart option*
</div>

At this stage in the process, we have a working Mimikatz executable on the Windows host, and our 


